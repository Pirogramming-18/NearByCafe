{% extends 'nav.html' %} {% block content %} {% load static %}

<div class="container1 d-flex">
    <div class="left_container">
        <div class="location_container d-flex flex-column">
            <div class="location_text fw-bold">지역 설정</div>
            <!-- <button class="search" onclick="onClickSearch('{{location}}')">검색하기</button> -->

            <!-- <button class="selected_location" onClick="onClickLocationButton()" >
                <input class="selected_location_cat" 
                type="text" 
                name="location" 
                readonly onfocus="this.blur();" 
                placeholder="선택한 지역 띄우기!" 
                /> 
            </button> -->

            <div class="d-flex flex-row align-items-center">
                <div class="selected_location location_input d-flex align-items-center" onclick="onClickLocationButton()">
                    <!-- <p>지역 선택</p> -->
                    <button class="location_picked" onclick="onClickLocationText()">
                        <span class="location_picked_text">{{loc}}</span>
                    </button>
                </div>
            </div>

            <div class="dropdown_location_list display_none">
                <div class="location_list d-flex flex-column shadow">
                    <div class="loc-text1">검색할 위치를 선택해주세요.</div>

                    <div class="d-flex flex-row">
                        <div class="d-flex flex-column">
                            {% for location in location_list_left %}
                            <div class="loc1 d-flex flex-row align-center">
                                <button class="loc_btn">
                                    <span class="loc_list" onclick="onClickLocationList()">{{location}}</span>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="d-flex flex-column">
                            {% for location in location_list_right %}
                            <div class="loc1 d-flex flex-row align-center">
                                <button class="loc_btn">
                                    <span class="loc_list" onclick="onClickLocationList()">{{location}}</span>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="find_keyword_container">
            <div class="keyword_text1 fw-bold">키워드 설정</div>
            <div class="keyword_box keyword_box_container d-flex flex-row justify-content-space-between">
                <div class="d-flex flex-column">
                    <div class="cat1 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="date" value="데이트" /> <span class="checkbox_list date_text">데이트</span>
                    </div>
                    <div class="cat1 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="quiet" value="조용한" /> <span class="checkbox_list">조용한</span>
                    </div>
                    <div class="cat1 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="dessert" value="디저트가 맛있는" /> <span class="checkbox_list">디저트가 맛있는</span>
                    </div>
                    <div class="cat1 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="kind" value="친절한" /> <span class="checkbox_list">친절한</span>
                    </div>
                    <div class="cat1 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="concent" value="콘센트가 많은" /> <span class="checkbox_list">콘센트가 많은</span>
                    </div>
                </div>

                <div class="d-flex flex-column">
                    <div class="cat2 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="work" value="작업하기 좋은" /> <span class="checkbox_list">작업하기 좋은</span>
                    </div>
                    <div class="cat2 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="loud" value="시끌벅적한" /> <span class="checkbox_list">시끌벅적한</span>
                    </div>
                    <div class="cat2 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="coffee" value="커피가 맛있는" /> <span class="checkbox_list">커피가 맛있는</span>
                    </div>
                    <div class="cat2 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="alone_cafe" value="혼카페" /> <span class="checkbox_list">혼카페</span>
                    </div>
                    <div class="cat2 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="bathroom" value="화장실 깨끗한" /> <span class="checkbox_list">화장실 깨끗한</span>
                    </div>
                </div>

                <div class="d-flex flex-column">
                    <div class="cat3 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="study" value="공부하기 좋은" /> <span class="checkbox_list">공부하기 좋은</span>
                    </div>
                    <div class="cat3 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="seat" value="의자가 편한" /> <span class="checkbox_list">의자가 편한</span>
                    </div>
                    <div class="cat3 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="cheap" value="저렴한" /> <span class="checkbox_list">저렴한</span>
                    </div>
                    <div class="cat3 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="big" value="장소가 넓은" /> <span class="checkbox_list">장소가 넓은</span>
                    </div>
                    <div class="cat3 d-flex flex-row align-center">
                        <input class="checkbox" type="checkbox" name="interior" value="인테리어가 예쁜" /> <span class="checkbox_list">인테리어가 예쁜</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="cafe_list_container">
            <div class="sort_container">
                <!-- <form action="" method="POST"> -->
                    {% csrf_token %}
                    <input type="hidden" name="cafe_location_name" id="cafe_location_name" value="" />
                    <input type="hidden" name="cafe_keyword_name" id="cafe_keyword_name" value="" />
                    <button class="search" type="button" onclick="onClickSearch()"><span class="btn_text3">카페 검색하기</span></button>
                <!-- </form> -->
                <div class="sort">
                    <button class="sort_abc"><span class="btn_text1">가나다 순</span></button>
                    <button class="sort_star"><span class="btn_text2">평점 순</span></button>
                </div>
                <p class="sort_text3">총 <span style="color: #df4629">갯수 넣기</span>개의 카페가 검색되었습니다.</p>
            </div>

            <!-- {% for cafe in cafe_list %} 
                cafe.image
                cafe.name
                cafe.address
                cafe.image 
            {% endfor %} -->

            <div class="cafe_list">
                  <!-- <div class="cafe d-flex">
                    <img src="" alt="" class="cafe_img">
                    <div class="cafe_info d-flex flex-column">
                        <span class="cafe_name">카페 상호명</span>                    
                        <span class="cafe_loc">서울시 마포구 와우산로 94</span>         
                        <span class="cafe_categ">#공부하기 좋은 #분위기 예쁜 #저렴한</span> 
                        <div class="cafe_star_info">             
                            <span style="color: #F8AA14">3.0</span>                     
                            <span>⭐️⭐️⭐️⭐️⭐️</span>                
                            <span style="color: #AAAAAA">(65)</span>                    
                        </div>
                    </div>
                </div>

                <div class="cafe d-flex">
                    <img src="" alt="" class="cafe_img">
                    <div class="cafe_info d-flex flex-column">
                        <span class="cafe_name">카페 상호명</span>                    
                        <span class="cafe_loc">서울시 마포구 와우산로 94</span>         
                        <span class="cafe_categ">#공부하기 좋은 #분위기 예쁜 #저렴한</span> 
                        <div class="cafe_star_info">             
                            <span style="color: #F8AA14">3.0</span>                     
                            <span>⭐️⭐️⭐️⭐️⭐️</span>                
                            <span style="color: #AAAAAA">(65)</span>                    
                        </div>
                    </div>
                </div>

                <div class="cafe d-flex">
                    <img src="" alt="" class="cafe_img">
                    <div class="cafe_info d-flex flex-column">
                        <span class="cafe_name">카페 상호명</span>                    
                        <span class="cafe_loc">서울시 마포구 와우산로 94</span>         
                        <span class="cafe_categ">#공부하기 좋은 #분위기 예쁜 #저렴한</span> 
                        <div class="cafe_star_info">             
                            <span style="color: #F8AA14">3.0</span>                     
                            <span>⭐️⭐️⭐️⭐️⭐️</span>                
                            <span style="color: #AAAAAA">(65)</span>                    
                        </div>
                    </div>
                </div>

                <div class="cafe d-flex">
                    <img src="" alt="" class="cafe_img">
                    <div class="cafe_info d-flex flex-column">
                        <span class="cafe_name">카페 상호명</span>                    
                        <span class="cafe_loc">서울시 마포구 와우산로 94</span>         
                        <span class="cafe_categ">#공부하기 좋은 #분위기 예쁜 #저렴한</span> 
                        <div class="cafe_star_info">             
                            <span style="color: #F8AA14">3.0</span>                     
                            <span>⭐️⭐️⭐️⭐️⭐️</span>                
                            <span style="color: #AAAAAA">(65)</span>                    
                        </div>
                    </div>
                </div>-->
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <button class="more_btn"><span class="more_text">더보기</span></button>
        </div>
    </div>

    <div id="map"></div>
</div>

<!-- <script src="/static/js/keyword.js"></script> -->
<!-- <script src="/static/js/find_cafe.js"></script> -->

<script>
    var container = document.getElementById('map');
    var latitude = {{latitude}};
    var longtitude = {{longtitude}};
    var options = {
        // center: new kakao.maps.LatLng( 37.61065041034093,126.99985276595638 ),
        center: new kakao.maps.LatLng(latitude,longtitude),
        level: 3
    };
   

    var map = new kakao.maps.Map(container, options);

    const panTo=(latitude,longtitude)=>{
    var moveLatLon=new kakao.maps.LatLng(latitude,longtitude);
    var markerPosition = new kakao.maps.LatLng(latitude,longtitude);
    var marker = new kakao.maps.Marker({
        position : markerPosition
    })
    marker.setMap(map);
    map.panTo(moveLatLon);
}

//find_cafe 페이지로 이동할 시 이전 메인페이지에 있던 값들 넘겨주면서 지도 이동 + 카페 리스트 띄움
const Search = async() => {
    //키워드 선택//
   
    const location = '{{loc}}';
    console.log('지역',location);

    const res = await fetch("/find_cafe_ajax/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: JSON.stringify({ location: location,}), 
    });

    // const res = await fetch('/cafe/find_cafe')
    // .then(console.log(Response))
    // .catch(console.log(console.error()))

    //받는거
    const { latitude: latitude, longtitude: longtitude, cafes: cafes } = await res.json();
    console.log(latitude, longtitude, cafes);
    cafeHandleResponse(cafes);
    panTo(latitude, longtitude);
    cafeMarker(cafes);
};


const cafeMarker=(cafes) => {

    let cafeNameArr = [];
    let cafeLatArr = [];
    let cafeLngArr = [];


    var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    cafes.forEach(item => {
        cafeNameArr.push(item.name);
        cafeLatArr.push(item.latitude);
        cafeLngArr.push(item.longtitude);
    })

    var positions = []
    for(var i = 0; i <= cafes.length; i++){
    positions.push({title : cafeNameArr[i],
                        latlng : new kakao.maps.LatLng(cafeLatArr[i],cafeLngArr[i])});

    };

    for (var i = 0; i <= cafes.length; i++){

        var imageSize = new kakao.maps.Size(24, 35);
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
        var marker = new kakao.maps.Marker({
        map: map, // 마커를 표시할 지도
        position: positions[i].latlng, // 마커를 표시할 위치
        title : positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
        image : markerImage // 마커 이미지
    });
    }

}
</script>
<script>
    const MAX_CHECKBOXES = 3;
    var checkboxes = document.querySelectorAll(".checkbox");
    var checkedCheckboxes = [];
    var checked = [];
    const locationInput = document.querySelector("#cafe_location_name");
   

    // 모든 체크박스마다 이벤트 리스너 추가
    checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener("change", function () {
            if (this.checked) {
                checkedCheckboxes.push(this.value); // 체크된 리스트에 추가
                checked.push(this);
                if (checkedCheckboxes.length > MAX_CHECKBOXES) {
                    var oldestCheckbox = checkedCheckboxes.shift();
                    var oldestCheck = checked.shift();
                    oldestCheck.checked = false;
                }
            } else {
                checkedCheckboxes.splice(checkedCheckboxes.indexOf(this), 1);
            }
        });
    });
    console.log(checkedCheckboxes);
    const dropdown_menu = document.querySelector(".dropdown_location_list");
    const location_drop = document.querySelector(".location_drop");

    var clicked_state = 0;
    function onClickLocationButton() {
        if (clicked_state === 1) {
            dropdown_menu.classList.add("display_none");
            clicked_state = 0;
        } else {
            dropdown_menu.classList.remove("display_none");
            clicked_state = 1;
        }
    }

    function onClickLocationText() {
        if (clicked_state === 1) {
            dropdown_menu.classList.add("display_none");
            clicked_state = 0;
        } else {
            dropdown_menu.classList.remove("display_none");
            clicked_state = 1;
        }
    }

    var form_keyword_input = document.querySelector('input[name="cafe_keyword_name"]');

    function onClickLocationList() {
        var location_picked = event.target;
        var location_each = location_picked.innerText;

        // const location_input = document.querySelector(".location_input");
        // let location_placeholder = location_input.placeholder;
        // location_placeholder = "";

        const location_picked_text = document.querySelector(".location_input");
        location_picked_text.innerHTML = `<button class="location_picked" onclick="${onClickLocationText()}">
            <span class="location_picked_text">${location_each}</span>
            </button>`;

       
        locationInput.value = location_each;
        console.log(locationInput);
    }

    var clickedKeywordList = [];
    function onClickKeyword() {
        var keyword_picked = event.target;
        var keyword_each = keyword_picked.value;
        clickedKeywordList.push(keyword_each);
        console.log(clickedKeywordList);
        form_keyword_input.value = JSON.stringify(clickedKeywordList);
    }

    console.log(checkedCheckboxes);
    const onClickSearch = async () => {
        //키워드 선택//
        console.log(checkedCheckboxes)
        checked_keywords=checkedCheckboxes
        const location = locationInput.value;
        console.log('지역',location);

        const res = await fetch("/find_cafe_ajax/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: JSON.stringify({ location: location, checked_keywords: checked_keywords}), 
        });

        // const res = await fetch('/cafe/find_cafe')
        // .then(console.log(Response))
        // .catch(console.log(console.error()))

        //받는거
        const { latitude: latitude, longtitude: longtitude, cafes: cafes } = await res.json();
        console.log(latitude, longtitude, cafes);
        cafeHandleResponse(cafes);
        panTo(latitude, longtitude);
        cafeMarker(cafes);
    };
  

    const cafeHandleResponse = (cafes) => {
        var element = document.querySelector(".cafe_list");
        // element.innerHTML = `<div class="cafe_list">`;
        cafes.forEach((item) => {
            let star = "⭐⭐⭐⭐⭐";
            if ( 1 <= item.average_star && item.average_star < 2) {
                star = "⭐☆☆☆☆";
            } else if ( 2 <= item.average_star && item.average_star < 3) {
                star = "⭐⭐☆☆☆";
            } else if (3 <= item.average_star && item.average_star < 4) {
                star = "⭐⭐⭐☆☆";
            } else if (4 <= item.average_star && itme.average_star < 5) {
                star = "⭐⭐⭐⭐☆";
            } else if (5 <= item.average_star) {
                star = "⭐⭐⭐⭐⭐";
            }
            console.log(item.average_star)
            element.innerHTML += `
        <div class="cafe d-flex">
            <img src="/media/${item.image}" alt="이미지가 없습니다" class="cafe_img">
        <div class="d-flex flex-column">
        <a href='cafe_detail/${item.id}'  class="find_cafe_name">${item.name}</a>
        <span class="cafe_loc">${item.address}</span>
        <span class="cafe_categ">${item.keywords}</span>
        <div class="cafe_star_info">
            <span style="color: #F8AA14">${item.average_star}점</span>
            <span style="color: #F9B717; font-size: 18px; font-weight: bold" >${star}</span>
            <span>리뷰 수</span>                   
        </div>
        </div>
    </div>`;
        });
    };
Search();
</script>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"
></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- <script src="static/find_cafe.js" -->
{% endblock %}
